<%- include('../partials/header') %>

    <main class="container max-w-[1280px] mx-auto px-4 md:px-10 py-8 flex-1">
        <!-- Breadcrumb -->
        <nav class="flex mb-8 text-sm text-gray-500" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="/" class="inline-flex items-center hover:text-primary">
                        <span class="material-symbols-outlined text-lg mr-2">home</span>
                        Home
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <span class="material-symbols-outlined text-gray-400 mx-1">chevron_right</span>
                        <a href="/shops" class="hover:text-primary">Shops</a>
                    </div>
                </li>
                <li>
                    <div class="flex items-center">
                        <span class="material-symbols-outlined text-gray-400 mx-1">chevron_right</span>
                        <a href="/shops/<%= product.shop_id %>" class="hover:text-primary">
                            <%= product.shop_name %>
                        </a>
                    </div>
                </li>
                <li aria-current="page">
                    <div class="flex items-center">
                        <span class="material-symbols-outlined text-gray-400 mx-1">chevron_right</span>
                        <span class="text-gray-900 font-medium">
                            <%= product.name %>
                        </span>
                    </div>
                </li>
            </ol>
        </nav>

        <div class="bg-white rounded-xl border border-[#dbdfe6] dark:border-gray-700 overflow-hidden shadow-sm">
            <div class="md:flex">
                <!-- Product Image -->
                <div
                    class="md:w-1/2 bg-gray-50 flex items-center justify-center p-8 border-r border-[#dbdfe6] dark:border-gray-700">
                    <% if (product.image_url) { %>
                        <img src="<%= product.image_url %>" alt="<%= product.name %>"
                            class="max-h-[400px] object-contain mix-blend-multiply">
                        <% } else { %>
                            <span class="material-symbols-outlined text-9xl text-gray-300">image</span>
                            <% } %>
                </div>

                <!-- Product Details -->
                <div class="md:w-1/2 p-8 md:p-10 flex flex-col">
                    <div class="mb-4">
                        <span
                            class="bg-blue-100 text-primary text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">In
                            Stock</span>
                    </div>
                    <h1 class="text-3xl md:text-4xl font-bold text-[#111318] mb-4 leading-tight">
                        <%= product.name %>
                    </h1>

                    <div class="flex items-baseline mb-6 border-b border-gray-100 pb-6">
                        <span class="text-4xl font-bold text-primary mr-3">₹<%= parseFloat(product.price).toFixed(2) %>
                                </span>
                        <span class="text-gray-500">Sold by <a href="/shops/<%= product.shop_id %>"
                                class="text-primary hover:underline font-medium">
                                <%= product.shop_name %>
                            </a></span>
                    </div>

                    <% if (product.description) { %>
                        <div class="mb-8 flex-grow">
                            <h3 class="text-sm font-bold uppercase tracking-wider text-gray-500 mb-3">Product
                                Description</h3>
                            <p class="text-gray-700 leading-relaxed text-lg">
                                <%= product.description %>
                            </p>
                        </div>
                        <% } %>

                            <div class="flex flex-col gap-4 mt-auto">
                                <% if (locals.user) { %>
                                    <form action="/cart/add" method="POST" class="w-full">
                                        <input type="hidden" name="product_id" value="<%= product.id %>">
                                        <input type="hidden" name="shop_id" value="<%= product.shop_id %>">

                                        <div class="flex items-end gap-4 mb-6">
                                            <div class="w-24">
                                                <label for="quantity"
                                                    class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                                <input type="number" name="quantity" id="quantity" value="1" min="1"
                                                    class="w-full border-gray-300 rounded-lg focus:ring-primary focus:border-primary text-center">
                                            </div>
                                        </div>

                                        <button type="submit"
                                            class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-xl flex items-center justify-center gap-3 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                            <span class="material-symbols-outlined">shopping_cart</span>
                                            <span>Add to Cart</span>
                                        </button>
                                    </form>
                                    <% } else { %>
                                        <a href="/login"
                                            class="w-full bg-gray-900 hover:bg-black text-white font-bold py-4 px-8 rounded-xl flex items-center justify-center gap-3 transition-all">
                                            <span class="material-symbols-outlined">login</span>
                                            <span>Log in to Purchase</span>
                                        </a>
                                        <% } %>

                                            <div class="flex gap-4 mt-4 text-sm text-gray-500 justify-center">
                                                <div class="flex items-center gap-1"><span
                                                        class="material-symbols-outlined text-green-500 text-lg">verified</span>
                                                    Genuine Part</div>
                                                <div class="flex items-center gap-1"><span
                                                        class="material-symbols-outlined text-blue-500 text-lg">local_shipping</span>
                                                    Fast Shipping</div>
                                                <div class="flex items-center gap-1"><span
                                                        class="material-symbols-outlined text-purple-500 text-lg">security</span>
                                                    Warranty</div>
                                            </div>
                            </div>
                </div>
            </div>
        </div>

        <!-- Comparison Section -->
        <% if (otherShopProducts && otherShopProducts.length> 0) { %>
            <div class="mt-12">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">compare_arrows</span>
                    Compare Prices
                </h2>
                <div class="bg-white rounded-xl border border-[#dbdfe6] overflow-hidden shadow-sm">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Seller
                                </th>
                                <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Price
                                </th>
                                <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Difference</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-right">
                                    Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr class="bg-blue-50/50">
                                <td class="px-6 py-4 font-medium text-gray-900">
                                    <%= product.shop_name %>
                                        <span
                                            class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">Current</span>
                                </td>
                                <td class="px-6 py-4 font-bold text-primary">₹<%= parseFloat(product.price).toFixed(2)
                                        %>
                                </td>
                                <td class="px-6 py-4 text-gray-400">—</td>
                                <td class="px-6 py-4 text-right transform scale-90 origin-right">
                                    <span class="text-gray-400 text-sm">Viewing</span>
                                </td>
                            </tr>
                            <% otherShopProducts.forEach(otherProduct=> { %>
                                <% const productPrice=parseFloat(product.price); const
                                    otherPrice=parseFloat(otherProduct.price); const diff=productPrice - otherPrice;
                                    const percent=Math.round((Math.abs(diff) / productPrice) * 100); %>
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4 font-medium text-gray-900">
                                            <%= otherProduct.shop_name %>
                                        </td>
                                        <td class="px-6 py-4 font-semibold text-gray-700">₹<%= otherPrice.toFixed(2) %>
                                        </td>
                                        <td class="px-6 py-4">
                                            <% if (otherPrice < productPrice) { %>
                                                <span
                                                    class="text-green-600 font-bold text-sm bg-green-50 px-2 py-1 rounded">
                                                    Save ₹<%= diff.toFixed(2) %> (<%= percent %>%)
                                                </span>
                                                <% } else if (otherPrice> productPrice) { %>
                                                    <span class="text-red-500 font-medium text-sm">
                                                        +₹<%= Math.abs(diff).toFixed(2) %>
                                                    </span>
                                                    <% } else { %>
                                                        <span class="text-gray-500 text-sm">Same Price</span>
                                                        <% } %>
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            <a href="/products/<%= otherProduct.id %>"
                                                class="inline-flex items-center text-sm font-bold text-primary hover:text-blue-700">
                                                View Deal <span
                                                    class="material-symbols-outlined text-sm ml-1">arrow_forward</span>
                                            </a>
                                        </td>
                                    </tr>
                                    <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
            <% } %>

                <!-- Similar Products Grid (Keep logic but style differently) -->
                <% if (mlSimilarProducts && mlSimilarProducts.length> 0) { %>
                    <div class="mt-16 border-t border-gray-200 pt-12">
                        <h2 class="text-2xl font-bold mb-8">Related Products</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                            <% mlSimilarProducts.forEach(product=> { %>
                                <a href="/products/<%= product.id %>" class="group block">
                                    <div
                                        class="bg-gray-100 rounded-lg mb-4 aspect-square flex items-center justify-center overflow-hidden">
                                        <% if (product.image_url) { %>
                                            <img src="<%= product.image_url %>" alt="<%= product.name %>"
                                                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                                            <% } else { %>
                                                <span
                                                    class="material-symbols-outlined text-4xl text-gray-300">image</span>
                                                <% } %>
                                    </div>
                                    <h3
                                        class="font-bold text-gray-900 group-hover:text-primary transition-colors text-sm line-clamp-2 mb-1">
                                        <%= product.name %>
                                    </h3>
                                    <p class="text-xs text-gray-500 mb-2">
                                        <%= product.shop_name %>
                                    </p>
                                    <span class="font-bold text-primary">₹<%= typeof product.price==='number' ?
                                            product.price.toFixed(2) : parseFloat(product.price).toFixed(2) %></span>
                                </a>
                                <% }) %>
                        </div>
                    </div>
                    <% } %>
    </main>

    <%- include('../partials/footer') %>