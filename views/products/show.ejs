<%- include('../partials/header') %>

<main class="container max-w-screen-xl mx-auto px-4 py-8 flex-1">
    <div class="mb-4">
        <a href="/shops/<%= product.shop_id %>" class="udemy-text-primary hover:underline text-sm font-semibold">
            <i class="fas fa-arrow-left mr-1"></i> Back to <%= product.shop_name %>
        </a>
    </div>

    <div class="bg-white border border-gray-200 overflow-hidden">
        <div class="md:flex">
            <div class="md:w-1/2 p-6">
                <div class="h-96 bg-gray-100 flex items-center justify-center overflow-hidden">
                    <% if (product.image_url) { %>
                        <img src="<%= product.image_url %>" alt="<%= product.name %>" class="object-contain w-full h-full">
                    <% } else { %>
                        <div class="text-5xl text-gray-400">
                            <i class="fas fa-shopping-basket"></i>
                        </div>
                    <% } %>
                </div>
            </div>
            <div class="md:w-1/2 p-8">
                <h1 class="text-3xl font-bold mb-4"><%= product.name %></h1>
                <div class="flex items-center mb-6">
                    <span class="font-bold text-3xl udemy-text-primary mr-4">₹<%= parseFloat(product.price).toFixed(2) %></span>
                    <span class="text-gray-600 text-sm">from <%= product.shop_name %></span>
                </div>
                <% if (product.description) { %>
                    <div class="mb-8">
                        <h3 class="text-lg font-bold mb-3">Description</h3>
                        <p class="text-gray-700 leading-relaxed"><%= product.description %></p>
                    </div>
                <% } %>
                
                <% if (locals.user) { %>
                    <form action="/cart/add" method="POST" class="mb-6">
                        <input type="hidden" name="product_id" value="<%= product.id %>">
                        <input type="hidden" name="shop_id" value="<%= product.shop_id %>">
                        <div class="flex items-center gap-4">
                            <div>
                                <label for="quantity" class="block text-sm font-semibold text-gray-700 mb-2">Quantity</label>
                                <input 
                                    type="number" 
                                    name="quantity" 
                                    id="quantity" 
                                    value="1" 
                                    min="1" 
                                    class="w-20 border border-gray-300 p-2 text-center focus:outline-none focus:border-purple-600"
                                >
                            </div>
                            <div class="flex-1">
                                <button type="submit" class="w-full udemy-btn py-3 mt-6">
                                    <i class="fas fa-shopping-cart mr-2"></i>
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    </form>
                <% } else { %>
                    <div class="mb-6">
                        <a href="/login" class="udemy-btn py-3 px-6 inline-block">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            Log in to Add to Cart
                        </a>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
    
    <!-- ML Recommendations: Customers Also Bought -->
    <% if (mlAlsoBought && mlAlsoBought.length > 0) { %>
        <div class="mt-8">
            <h3 class="text-2xl font-bold mb-4">
                <i class="fas fa-users text-purple-600 mr-2"></i>
                Customers Who Bought This Also Bought
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                <% mlAlsoBought.forEach(product => { %>
                    <a href="/products/<%= product.product_id || product.id %>" class="udemy-product-card">
                        <div class="relative">
                            <% if (product.image_url) { %>
                                <img src="<%= product.image_url %>" alt="<%= product.name %>" class="udemy-product-image">
                            <% } else { %>
                                <div class="udemy-product-image bg-gray-100 flex items-center justify-center">
                                    <i class="fas fa-shopping-basket text-4xl text-gray-400"></i>
                                </div>
                            <% } %>
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-sm line-clamp-2 mb-1"><%= product.name %></h3>
                            <p class="udemy-instructor-badge line-clamp-1"><%= product.shop_name %></p>
                            <div class="mt-2">
                                <span class="udemy-price">₹<%= typeof product.price === 'number' ? product.price.toFixed(2) : parseFloat(product.price).toFixed(2) %></span>
                            </div>
                        </div>
                    </a>
                <% }) %>
            </div>
        </div>
    <% } %>

    <!-- ML Recommendations: Similar Products -->
    <% if (mlSimilarProducts && mlSimilarProducts.length > 0) { %>
        <div class="mt-8">
            <h3 class="text-2xl font-bold mb-4">
                <i class="fas fa-th-large text-purple-600 mr-2"></i>
                Similar Products
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                <% mlSimilarProducts.forEach(product => { %>
                    <a href="/products/<%= product.id %>" class="udemy-product-card">
                        <div class="relative">
                            <% if (product.image_url) { %>
                                <img src="<%= product.image_url %>" alt="<%= product.name %>" class="udemy-product-image">
                            <% } else { %>
                                <div class="udemy-product-image bg-gray-100 flex items-center justify-center">
                                    <i class="fas fa-shopping-basket text-4xl text-gray-400"></i>
                                </div>
                            <% } %>
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-sm line-clamp-2 mb-1"><%= product.name %></h3>
                            <p class="udemy-instructor-badge line-clamp-1"><%= product.shop_name %></p>
                            <div class="mt-2">
                                <span class="udemy-price">₹<%= typeof product.price === 'number' ? product.price.toFixed(2) : parseFloat(product.price).toFixed(2) %></span>
                            </div>
                        </div>
                    </a>
                <% }) %>
            </div>
        </div>
    <% } %>

    <% if (otherShopProducts && otherShopProducts.length > 0) { %>
        <div class="mt-8">
            <h3 class="text-2xl font-bold mb-6">Compare Prices</h3>
            <div class="bg-white border border-gray-200 overflow-hidden">
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-50 text-left border-b border-gray-200">
                            <th class="px-6 py-4 font-semibold text-sm">Shop</th>
                            <th class="px-6 py-4 font-semibold text-sm">Price</th>
                            <th class="px-6 py-4 font-semibold text-sm">Comparison</th>
                            <th class="px-6 py-4 font-semibold text-sm">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b border-gray-200 bg-purple-50">
                            <td class="px-6 py-4 font-semibold"><%= product.shop_name %> (Current)</td>
                            <td class="px-6 py-4 font-bold udemy-text-primary">₹<%= parseFloat(product.price).toFixed(2) %></td>
                            <td class="px-6 py-4">-</td>
                            <td class="px-6 py-4">-</td>
                        </tr>
                        <% otherShopProducts.forEach(otherProduct => { %>
                            <% 
                            const productPrice = parseFloat(product.price);
                            const otherPrice = parseFloat(otherProduct.price);
                            %>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-6 py-4"><%= otherProduct.shop_name %></td>
                                <td class="px-6 py-4 font-semibold">₹<%= otherPrice.toFixed(2) %></td>
                                <td class="px-6 py-4">
                                    <% if (otherPrice < productPrice) { %>
                                        <span class="text-green-600 font-semibold">
                                            Save ₹<%= (productPrice - otherPrice).toFixed(2) %> (<%= Math.round((productPrice - otherPrice) / productPrice * 100) %>%)
                                        </span>
                                    <% } else if (otherPrice > productPrice) { %>
                                        <span class="text-red-600 font-semibold">
                                            ₹<%= (otherPrice - productPrice).toFixed(2) %> more (<%= Math.round((otherPrice - productPrice) / productPrice * 100) %>%)
                                        </span>
                                    <% } else { %>
                                        <span class="text-gray-600">Same price</span>
                                    <% } %>
                                </td>
                                <td class="px-6 py-4">
                                    <% if (locals.user) { %>
                                        <form action="/cart/add" method="POST">
                                            <input type="hidden" name="product_id" value="<%= otherProduct.id %>">
                                            <input type="hidden" name="shop_id" value="<%= otherProduct.shop_id %>">
                                            <input type="hidden" name="quantity" value="1">
                                            <button type="submit" class="udemy-btn-outline px-4 py-2 text-sm">
                                                Add to Cart
                                            </button>
                                        </form>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    <% } %>
</main>

<%- include('../partials/footer') %> 