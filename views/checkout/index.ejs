<%- include('../partials/header') %>

    <div class="container max-w-[1280px] mx-auto px-4 md:px-10 py-8 min-h-screen">
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-3 text-[#111318] dark:text-white">Secure Checkout</h1>
            <nav class="flex text-sm text-gray-500" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3">
                    <li class="inline-flex items-center">
                        <a href="/" class="inline-flex items-center hover:text-primary">
                            <span class="material-symbols-outlined text-lg mr-2">home</span>
                            Home
                        </a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-gray-400 mx-1">chevron_right</span>
                            <a href="/cart" class="hover:text-primary">Cart</a>
                        </div>
                    </li>
                    <li aria-current="page">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-gray-400 mx-1">chevron_right</span>
                            <span class="text-gray-900 font-medium">Checkout</span>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Checkout Form -->
            <div class="lg:w-8/12 space-y-6">
                <!-- Delivery Address -->
                <div
                    class="bg-white dark:bg-gray-800 border border-[#dbdfe6] dark:border-gray-700 rounded-xl shadow-sm overflow-hidden">
                    <div
                        class="bg-gray-50 dark:bg-gray-900 border-b border-[#dbdfe6] dark:border-gray-700 p-6 flex items-center justify-between">
                        <h2 class="text-lg font-bold text-[#111318] dark:text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">location_on</span>
                            Delivery Address
                        </h2>
                        <span
                            class="text-xs font-medium text-gray-500 bg-white dark:bg-gray-800 border border-[#dbdfe6] dark:border-gray-700 px-2 py-1 rounded">Step
                            1 of 2</span>
                    </div>
                    <div class="p-6">
                        <form id="checkoutForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="name"
                                        class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Full
                                        Name</label>
                                    <div class="relative">
                                        <span
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                            <span class="material-symbols-outlined text-sm">person</span>
                                        </span>
                                        <input type="text" id="name" name="name" value="<%= locals.user.name %>"
                                            class="w-full bg-gray-50 dark:bg-gray-700 border border-[#dbdfe6] dark:border-gray-600 rounded-lg pl-10 pr-4 py-3 text-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent cursor-not-allowed"
                                            readonly>
                                    </div>
                                </div>
                                <div>
                                    <label for="email"
                                        class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Email
                                        Address</label>
                                    <div class="relative">
                                        <span
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                            <span class="material-symbols-outlined text-sm">mail</span>
                                        </span>
                                        <input type="email" id="email" name="email" value="<%= locals.user.email %>"
                                            class="w-full bg-gray-50 dark:bg-gray-700 border border-[#dbdfe6] dark:border-gray-600 rounded-lg pl-10 pr-4 py-3 text-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent cursor-not-allowed"
                                            readonly>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label for="phone"
                                    class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Phone Number
                                    *</label>
                                <div class="relative">
                                    <span
                                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                        <span class="material-symbols-outlined text-sm">call</span>
                                    </span>
                                    <input type="tel" id="phone" name="phone" placeholder="Enter your phone number"
                                        class="w-full border border-[#dbdfe6] dark:border-gray-600 rounded-lg pl-10 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white"
                                        required>
                                </div>
                            </div>

                            <div>
                                <label for="address"
                                    class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Street Address
                                    *</label>
                                <div class="relative">
                                    <span class="absolute top-3 left-3 flex pointer-events-none text-gray-400">
                                        <span class="material-symbols-outlined text-sm">home</span>
                                    </span>
                                    <textarea id="address" name="address" rows="3"
                                        placeholder="Enter your full address with apartment/house number, street, landmark"
                                        class="w-full border border-[#dbdfe6] dark:border-gray-600 rounded-lg pl-10 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white"
                                        required></textarea>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="city"
                                        class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">City
                                        *</label>
                                    <input type="text" id="city" name="city" placeholder="City"
                                        class="w-full border border-[#dbdfe6] dark:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white"
                                        required>
                                </div>
                                <div>
                                    <label for="state"
                                        class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">State
                                        *</label>
                                    <input type="text" id="state" name="state" placeholder="State"
                                        class="w-full border border-[#dbdfe6] dark:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white"
                                        required>
                                </div>
                                <div>
                                    <label for="pincode"
                                        class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Pincode
                                        *</label>
                                    <input type="text" id="pincode" name="pincode" placeholder="Pincode"
                                        class="w-full border border-[#dbdfe6] dark:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white"
                                        required>
                                </div>
                            </div>

                            <div>
                                <label for="notes"
                                    class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Delivery
                                    Instructions (Optional)</label>
                                <textarea id="notes" name="notes" rows="2"
                                    placeholder="Any specific instructions for finding location or delivery time preference"
                                    class="w-full border border-[#dbdfe6] dark:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white"></textarea>
                            </div>

                            <div class="flex items-center">
                                <input type="checkbox" id="save_address" name="save_address"
                                    class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary cursor-pointer">
                                <label for="save_address"
                                    class="ml-2 text-sm text-gray-600 dark:text-gray-400 cursor-pointer select-none">
                                    Save this address for future orders
                                </label>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Payment Method -->
                <div
                    class="bg-white dark:bg-gray-800 border border-[#dbdfe6] dark:border-gray-700 rounded-xl shadow-sm overflow-hidden">
                    <div
                        class="bg-gray-50 dark:bg-gray-900 border-b border-[#dbdfe6] dark:border-gray-700 p-6 flex items-center justify-between">
                        <h2 class="text-lg font-bold text-[#111318] dark:text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">payments</span>
                            Payment Method
                        </h2>
                        <span
                            class="text-xs font-medium text-gray-500 bg-white dark:bg-gray-800 border border-[#dbdfe6] dark:border-gray-700 px-2 py-1 rounded">Step
                            2 of 2</span>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <label
                                class="flex items-center border border-[#dbdfe6] dark:border-gray-700 p-4 rounded-xl cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-700 transition-colors group has-[:checked]:border-primary has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-gray-700/80 has-[:checked]:ring-1 has-[:checked]:ring-primary">
                                <input type="radio" id="payment_razorpay" name="payment_method" value="razorpay" checked
                                    class="w-5 h-5 text-primary border-gray-300 focus:ring-primary cursor-pointer">
                                <div class="ml-4 flex-1">
                                    <div class="flex items-center justify-between">
                                        <span class="font-bold text-[#111318] dark:text-white">Pay Online
                                            (Razorpay)</span>
                                        <img src="https://razorpay.com/assets/razorpay-glyph.svg" alt="Razorpay"
                                            class="h-6 opacity-80 group-hover:opacity-100 transition-opacity">
                                    </div>
                                    <p class="text-sm text-gray-500 mt-1">Credit/Debit Card, UPI, Wallets, NetBanking
                                    </p>
                                </div>
                            </label>

                            <label
                                class="flex items-center border border-[#dbdfe6] dark:border-gray-700 p-4 rounded-xl cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors group has-[:checked]:border-primary has-[:checked]:bg-gray-50 dark:has-[:checked]:bg-gray-700/80 has-[:checked]:ring-1 has-[:checked]:ring-primary disabled:opacity-50 disabled:cursor-not-allowed">
                                <input type="radio" id="payment_cod" name="payment_method" value="cod"
                                    class="w-5 h-5 text-primary border-gray-300 focus:ring-primary cursor-pointer">
                                <div class="ml-4 flex-1">
                                    <div class="flex items-center justify-between">
                                        <span class="font-bold text-[#111318] dark:text-white">Cash on Delivery</span>
                                        <span class="material-symbols-outlined text-gray-400">money</span>
                                    </div>
                                    <p class="text-sm text-gray-500 mt-1">Pay when your parts arrive</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="lg:w-4/12">
                <div
                    class="bg-white dark:bg-gray-800 border border-[#dbdfe6] dark:border-gray-700 rounded-xl shadow-sm sticky top-24 overflow-hidden">
                    <div class="bg-gray-50 dark:bg-gray-900 border-b border-[#dbdfe6] dark:border-gray-700 p-6">
                        <h2 class="text-lg font-bold text-[#111318] dark:text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">receipt_long</span>
                            Order Summary
                        </h2>
                    </div>
                    <div class="p-6">
                        <div class="max-h-64 overflow-y-auto mb-6 pr-2 custom-scrollbar">
                            <% cartItems.forEach(item=> { %>
                                <div
                                    class="flex items-center py-3 border-b border-gray-100 dark:border-gray-700 last:border-0">
                                    <div
                                        class="w-14 h-14 flex-shrink-0 mr-3 bg-gray-100 dark:bg-gray-700 rounded-lg p-1 border border-gray-200 dark:border-gray-600">
                                        <% if (item.image_url) { %>
                                            <img src="<%= item.image_url %>" alt="<%= item.product_name %>"
                                                class="w-full h-full object-contain mix-blend-multiply">
                                            <% } else { %>
                                                <div class="w-full h-full flex items-center justify-center">
                                                    <span class="material-symbols-outlined text-gray-400">image</span>
                                                </div>
                                                <% } %>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h3 class="text-sm font-bold text-[#111318] dark:text-white truncate"
                                            title="<%= item.product_name %>">
                                            <%= item.product_name %>
                                        </h3>
                                        <p class="text-xs text-gray-500 truncate">
                                            <%= item.shop_name %>
                                        </p>
                                        <div class="flex items-center justify-between mt-1">
                                            <span class="text-xs text-gray-500">Qty: <%= item.quantity %></span>
                                            <span class="font-bold text-sm text-[#111318] dark:text-white">₹<%=
                                                    (parseFloat(item.price) * item.quantity).toFixed(2) %></span>
                                        </div>
                                    </div>
                                </div>
                                <% }) %>
                        </div>

                        <div class="space-y-3 py-4 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500 dark:text-gray-400">Subtotal</span>
                                <span class="font-medium text-[#111318] dark:text-white">₹<%=
                                        parseFloat(cartTotal).toFixed(2) %></span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500 dark:text-gray-400">Delivery Fee</span>
                                <span class="text-green-600 font-bold">Free</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500 dark:text-gray-400">Taxes</span>
                                <span class="text-gray-500 dark:text-gray-400">Included</span>
                            </div>
                        </div>

                        <div class="flex justify-between py-4 border-t border-gray-200 dark:border-gray-700">
                            <span class="text-lg font-bold text-[#111318] dark:text-white">Total</span>
                            <span class="text-2xl font-black text-primary">₹<%= parseFloat(cartTotal).toFixed(2) %>
                                    </span>
                        </div>

                        <button id="placeOrderBtn"
                            class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 mt-2">
                            <span>Confirm Order</span>
                            <span class="material-symbols-outlined">arrow_forward</span>
                        </button>

                        <p class="text-xs text-center text-gray-500 mt-4 leading-relaxed">
                            By placing your order, you agree to AutoMasters' <a href="#"
                                class="text-primary hover:underline">Terms of Service</a> and <a href="#"
                                class="text-primary hover:underline">Privacy Policy</a>
                        </p>

                        <div class="mt-4 flex items-center justify-center gap-2 text-xs text-gray-400">
                            <span class="material-symbols-outlined text-sm">lock</span>
                            <span>Secure SSL Encryption</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Razorpay Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const placeOrderBtn = document.getElementById('placeOrderBtn');

            placeOrderBtn.addEventListener('click', async function () {
                // Form validation
                const phone = document.getElementById('phone').value;
                const address = document.getElementById('address').value;
                const city = document.getElementById('city').value;
                const state = document.getElementById('state').value;
                const pincode = document.getElementById('pincode').value;
                const notes = document.getElementById('notes').value;

                if (!phone || !address || !city || !state || !pincode) {
                    alert('Please fill all required fields');
                    return;
                }

                // Show loading state
                const originalBtnContent = placeOrderBtn.innerHTML;
                placeOrderBtn.innerHTML = '<span class="material-symbols-outlined animate-spin">refresh</span> Processing...';
                placeOrderBtn.disabled = true;

                // Prepare address data
                const fullAddress = `${address}, ${city}, ${state} - ${pincode} ${notes ? '(' + notes + ')' : ''}`;

                try {
                    // Create order
                    const response = await fetch('/checkout/create-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            address: fullAddress,
                            phone
                        })
                    });

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || 'Failed to create order');
                    }

                    // Choose payment method
                    const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;

                    if (paymentMethod === 'razorpay') {
                        // For development mode or if backend explicitly sets dev_mode
                        if (data.dev_mode) {
                            await handlePaymentSuccess({
                                dev_mode: true,
                                order_id: data.order.id
                            });
                            return;
                        }

                        // Initialize Razorpay
                        const options = {
                            key: data.key_id,
                            amount: data.order.amount * 100,
                            currency: data.order.currency,
                            name: 'AutoMasters',
                            description: 'Purchase from AutoMasters',
                            image: 'https://cdn-icons-png.flaticon.com/512/741/741407.png', // Replace with car icon
                            order_id: data.order.id,
                            prefill: {
                                name: data.user.name,
                                email: data.user.email,
                                contact: data.user.phone
                            },
                            theme: {
                                color: '#135bec'
                            },
                            modal: {
                                ondismiss: function () {
                                    placeOrderBtn.innerHTML = originalBtnContent;
                                    placeOrderBtn.disabled = false;
                                }
                            },
                            handler: function (response) {
                                handlePaymentSuccess({
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_order_id: response.razorpay_order_id,
                                    razorpay_signature: response.razorpay_signature,
                                    order_id: data.order.id
                                });
                            }
                        };

                        const rzp = new Razorpay(options);
                        rzp.open();

                    } else if (paymentMethod === 'cod') {
                        await handlePaymentSuccess({
                            dev_mode: true,
                            order_id: data.order.id
                        });
                    }
                } catch (error) {
                    console.error('Error during checkout:', error);
                    alert(error.message || 'An error occurred during checkout');
                    placeOrderBtn.innerHTML = originalBtnContent;
                    placeOrderBtn.disabled = false;
                }
            });

            // Handle payment verification and redirect to confirmation
            async function handlePaymentSuccess(paymentData) {
                try {
                    const response = await fetch('/checkout/verify-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(paymentData)
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Redirect to order confirmation page
                        window.location.href = `/checkout/confirmation/${data.order_id}`;
                    } else {
                        throw new Error(data.message || 'Payment verification failed');
                    }
                } catch (error) {
                    console.error('Error verifying payment:', error);
                    alert(error.message || 'An error occurred during payment verification');
                    placeOrderBtn.innerHTML = 'Confirm Order';
                    placeOrderBtn.disabled = false;
                }
            }
        });
    </script>

    <!-- Add a direct test link for debugging - remove in prod -->
    <!-- 
<div class="fixed bottom-4 right-4 z-50">
    <a href="/checkout/confirmation/2" class="bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm">
        <i class="fas fa-bug mr-2"></i> Test Order Confirmation
    </a>
</div> 
-->

    <%- include('../partials/footer') %>